name: Update Bitwarden CLI Version

on:
  schedule:
    - cron: "0 6 * * *" # Daily at 6 AM UTC
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  update-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get latest Bitwarden CLI release
        id: latest-release
        run: |
          curl -sLo /tmp/output.json \
            --url https://api.github.com/repos/bitwarden/clients/releases/latest \
            --request GET \
            --header "X-GitHub-Api-Version: 2022-11-28" \
            --header "Authorization: Bearer ${GITHUB_TOKEN}"
          cat /tmp/output.json
          LATEST=$(jq -r .tag_name /tmp/output.json | cut -d v -f 2)
          echo ${LATEST} > ./VERSION
          echo "version=${LATEST}" >> $GITHUB_OUTPUT

      - name: Update Chart.yaml
        run: make sync-helm

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update bitwarden CLI to ${{ steps.latest-release.outputs.version }}"
          title: "Update Bitwarden CLI to ${{ steps.latest-release.outputs.version }}"
          body: |
            Updates Bitwarden CLI version to the latest release.

            - Release: [${{ steps.latest-release.outputs.version }}](https://github.com/bitwarden/clients/releases/tag/cli-v${{ steps.latest-release.outputs.version }})
          branch: update-bitwarden-cli/${{ steps.latest-release.outputs.version }}
